<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fuel Product Analysis Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500;600&display=swap');

    :root {
      --blue-deep: #0f1f3d;
      --blue-mid: #1e3c72;
      --blue-accent: #2a5298;
      --purple: #7e22ce;
      --red: #dc2626;
      --green: #059669;
      --amber: #d97706;
      --diesel: #111827;
      --unleaded: #10b981;
      --vpower: #dc2626;
      --bg: #f0f4f8;
      --card-bg: #ffffff;
      --text-primary: #0f172a;
      --text-muted: #64748b;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Barlow', sans-serif;
      background: var(--bg);
      background-image: 
        radial-gradient(ellipse at 0% 0%, rgba(30,60,114,0.12) 0%, transparent 60%),
        radial-gradient(ellipse at 100% 100%, rgba(126,34,206,0.10) 0%, transparent 60%);
      min-height: 100vh;
      padding: 24px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    /* HEADER */
    .header {
      background: linear-gradient(135deg, var(--blue-deep) 0%, var(--blue-mid) 60%, var(--purple) 100%);
      border-radius: 20px;
      padding: 32px 40px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 8px 32px rgba(15,31,61,0.25);
      position: relative;
      overflow: hidden;
    }
    .header::before {
      content: '‚õΩ';
      position: absolute;
      right: -20px;
      top: -20px;
      font-size: 160px;
      opacity: 0.06;
      transform: rotate(-15deg);
    }
    .header-left h1 {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 2.6em;
      font-weight: 900;
      color: white;
      letter-spacing: 1px;
      text-transform: uppercase;
      line-height: 1;
    }
    .header-left .subtitle {
      color: rgba(255,255,255,0.65);
      font-size: 0.95em;
      margin-top: 6px;
      letter-spacing: 0.5px;
    }
    .header-right {
      text-align: right;
      color: rgba(255,255,255,0.85);
      font-size: 0.9em;
    }
    .header-right strong {
      display: block;
      font-size: 1.1em;
      color: white;
    }

    /* METRICS GRID */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .metric-card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      border-top: 4px solid var(--blue-mid);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    .metric-card.red-top { border-top-color: var(--red); }
    .metric-card.green-top { border-top-color: var(--green); }
    .metric-card.amber-top { border-top-color: var(--amber); }
    .metric-card .m-icon {
      font-size: 1.6em;
      margin-bottom: 8px;
      opacity: 0.8;
    }
    .metric-card .m-value {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 2em;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }
    .metric-card .m-label {
      font-size: 0.82em;
      color: var(--text-muted);
      margin-top: 4px;
      font-weight: 500;
    }

    /* TARGET PROGRESS SECTION */
    .target-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .section-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.4em;
      font-weight: 700;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 2px;
      background: linear-gradient(to right, var(--blue-mid), transparent);
    }

    .target-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .target-card {
      border-radius: 14px;
      padding: 22px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s;
    }
    .target-card:hover { transform: translateY(-3px); }
    .target-card.diesel { background: linear-gradient(135deg, #0f172a, #1e293b); color: white; }
    .target-card.unleaded { background: linear-gradient(135deg, #064e3b, #065f46); color: white; }
    .target-card.vpower { background: linear-gradient(135deg, #7f1d1d, #991b1b); color: white; }

    .target-card .tc-product {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.3em;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      opacity: 0.9;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tc-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .diesel .tc-dot { background: #6b7280; }
    .unleaded .tc-dot { background: #34d399; }
    .vpower .tc-dot { background: #f87171; }

    .target-card .tc-numbers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .tc-num-item .tc-val {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1.6em;
      font-weight: 700;
      line-height: 1;
    }
    .tc-num-item .tc-lbl {
      font-size: 0.78em;
      opacity: 0.65;
      margin-top: 3px;
    }

    .progress-track {
      background: rgba(255,255,255,0.15);
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .progress-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 1s ease;
      position: relative;
    }
    .progress-fill.on-track { background: linear-gradient(to right, #34d399, #10b981); }
    .progress-fill.below { background: linear-gradient(to right, #fbbf24, #f59e0b); }
    .progress-fill.critical { background: linear-gradient(to right, #f87171, #ef4444); }
    
    /* pace marker on progress bar */
    .progress-track { position: relative; }
    .pace-marker {
      position: absolute;
      top: -2px;
      width: 3px;
      height: 16px;
      background: white;
      border-radius: 2px;
      transform: translateX(-50%);
      z-index: 2;
      box-shadow: 0 0 6px rgba(255,255,255,0.8);
    }

    .tc-pct {
      display: flex;
      justify-content: space-between;
      font-size: 0.82em;
      opacity: 0.75;
    }
    .tc-status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.78em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 10px;
    }
    .badge-on-track { background: rgba(52,211,153,0.25); color: #34d399; }
    .badge-below { background: rgba(251,191,36,0.25); color: #fbbf24; }
    .badge-critical { background: rgba(248,113,113,0.25); color: #f87171; }

    /* FILTERS */
    .filter-bar {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 18px 24px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      align-items: flex-end;
      flex-wrap: wrap;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    .filter-group label {
      display: block;
      font-size: 0.78em;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    select {
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      background: white;
      color: var(--text-primary);
      font-family: 'Barlow', sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: border-color 0.2s;
      outline: none;
    }
    select:hover, select:focus { border-color: var(--blue-mid); }
    .btn {
      padding: 10px 22px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--blue-mid), var(--purple));
      color: white;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1em;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(30,60,114,0.3);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(30,60,114,0.4); }

    /* CHARTS */
    .chart-container {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      margin-bottom: 24px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    .charts-grid .chart-container { margin-bottom: 0; }
    .chart-wrapper {
      position: relative;
      height: 300px;
    }
    .chart-wrapper.tall { height: 400px; }

    /* STOCK ALERTS */
    .stock-section {
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .stock-section.all-safe {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      border: 1px solid #6ee7b7;
    }
    .stock-section.has-warning {
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
      border: 1px solid #fcd34d;
      animation: warningPulse 2.5s ease-in-out infinite;
    }
    .stock-section.has-critical {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border: 1px solid #fca5a5;
      animation: criticalPulse 2s ease-in-out infinite;
    }
    @keyframes warningPulse {
      0%,100% { box-shadow: 0 2px 12px rgba(217,119,6,0.15); }
      50% { box-shadow: 0 4px 24px rgba(217,119,6,0.35); }
    }
    @keyframes criticalPulse {
      0%,100% { box-shadow: 0 2px 12px rgba(220,38,38,0.2); }
      50% { box-shadow: 0 4px 28px rgba(220,38,38,0.45); }
    }
    .stock-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .stock-item {
      background: white;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .stock-item.critical { border: 2px solid #ef4444; }
    .stock-item.warning { border: 2px solid #f59e0b; }
    .stock-item.safe { border: 2px solid #10b981; }
    .si-name { font-weight: 700; font-size: 0.95em; margin-bottom: 8px; }
    .si-level { font-family: 'Barlow Condensed', sans-serif; font-size: 2em; font-weight: 700; }
    .si-level.critical { color: var(--red); }
    .si-level.warning { color: var(--amber); }
    .si-level.safe { color: var(--green); }
    .si-bar { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin: 8px 0; }
    .si-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }
    .si-fill.critical { background: var(--red); }
    .si-fill.warning { background: var(--amber); }
    .si-fill.safe { background: var(--green); }
    .si-status {
      font-size: 0.78em;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 20px;
      display: inline-block;
    }
    .si-status.critical { background: #fee2e2; color: var(--red); }
    .si-status.warning { background: #fef3c7; color: var(--amber); }
    .si-status.safe { background: #d1fae5; color: var(--green); }

    /* INSIGHTS */
    .insights-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .insights-list { list-style: none; }
    .insights-list li {
      padding: 14px 16px;
      border-left: 3px solid var(--blue-mid);
      background: #f8fafc;
      border-radius: 0 10px 10px 0;
      margin-bottom: 10px;
      font-size: 0.92em;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .insights-list li:hover {
      transform: translateX(6px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    /* DATA TABLE */
    .table-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .table-scroll { overflow-x: auto; max-height: 480px; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: linear-gradient(135deg, var(--blue-deep), var(--blue-mid));
      color: white;
      padding: 12px 14px;
      text-align: left;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      letter-spacing: 0.5px;
      font-size: 0.9em;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tbody td { padding: 11px 14px; border-bottom: 1px solid #f1f5f9; font-size: 0.88em; }
    tbody tr:hover { background: #f8fafc; }
    .var-pos { color: var(--green); font-weight: 700; }
    .var-neg { color: var(--red); font-weight: 700; }
    .var-alert { background: #fee2e2; padding: 2px 7px; border-radius: 4px; }

    /* TAB BUTTONS */
    .tab-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      color: white;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      opacity: 0.55;
      transition: opacity 0.2s, transform 0.2s;
      letter-spacing: 0.3px;
    }
    .tab-btn:hover { opacity: 0.8; transform: translateY(-1px); }
    .tab-btn.active { opacity: 1; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transform: translateY(-2px); }

    /* LOADING */
    .spinner-wrap { display: flex; justify-content: center; padding: 40px; }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid #e2e8f0;
      border-top-color: var(--blue-mid);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* FOOTER */
    footer {
      background: linear-gradient(135deg, var(--blue-deep), #1e293b);
      color: rgba(255,255,255,0.7);
      border-radius: 14px;
      padding: 20px 28px;
      text-align: center;
      font-size: 0.83em;
      line-height: 1.8;
    }
    footer strong { color: white; }

    @media (max-width: 900px) {
      .target-cards { grid-template-columns: 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <h1>‚õΩ Fuel Analysis Dashboard</h1>
      <div class="subtitle">Inventory Management ¬∑ Variance Tracking ¬∑ Target Performance</div>
    </div>
    <div class="header-right">
      <strong>Kiryan Energy Ltd</strong>
      <span>Confidential ¬∑ v2.2</span>
    </div>
  </div>

  <!-- TOP METRICS -->
  <div class="metrics-grid" id="metricsGrid">
    <div class="spinner-wrap" style="grid-column:1/-1"><div class="spinner"></div></div>
  </div>

  <!-- TARGET PROGRESS -->
  <div class="target-section">
    <div class="section-title">üéØ 2026 Monthly Target Progress</div>
    <div class="target-cards" id="targetCards">
      <div class="spinner-wrap"><div class="spinner"></div></div>
    </div>
  </div>

  <!-- STOCK ALERTS -->
  <div id="stockAlertSection"></div>

  <!-- FILTERS -->
  <div class="filter-bar">
    <div class="filter-group">
      <label>üìÖ Month</label>
      <select id="monthFilter" onchange="loadData()"></select>
    </div>
    <div class="filter-group">
      <label>üì¶ Product</label>
      <select id="productFilter">
        <option value="all">All Products</option>
        <option value="UX">UX - Unleaded Super</option>
        <option value="DX">DX - Diesel</option>
        <option value="VP">VP - V-Power</option>
      </select>
    </div>
    <div class="filter-group">
      <label>üìä Variance Filter</label>
      <select id="varianceFilter">
        <option value="all">All Variances</option>
        <option value="high">High Alert (&gt;5%)</option>
        <option value="medium">Medium (2‚Äì5%)</option>
        <option value="low">Low (&lt;2%)</option>
      </select>
    </div>
    <button class="btn" onclick="updateDashboard()">üîÑ Update</button>
  </div>

  <!-- DAILY SALES vs DAILY TARGET ‚Äî per product -->
  <div class="chart-container" id="targetChartSection">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:1.3em;font-weight:700;color:#0f172a;text-transform:uppercase;letter-spacing:1px;">
        üìà Daily Sales vs Daily Target
        <span style="font-size:0.7em;font-weight:400;color:#64748b;text-transform:none;letter-spacing:0;margin-left:8px;">Green = above target ¬∑ Red = below target</span>
      </div>
      <div style="display:flex;gap:8px;" id="productTabs">
        <button class="tab-btn active" onclick="switchTab('DX')" id="tab-DX" style="background:linear-gradient(135deg,#111827,#1f2937)">‚ö´ DX Diesel</button>
        <button class="tab-btn" onclick="switchTab('UX')" id="tab-UX" style="background:linear-gradient(135deg,#064e3b,#065f46)">üü¢ UX Unleaded</button>
        <button class="tab-btn" onclick="switchTab('VP')" id="tab-VP" style="background:linear-gradient(135deg,#7f1d1d,#991b1b)">üî¥ VP V-Power</button>
      </div>
    </div>
    <div id="targetChart-DX" class="product-chart-panel">
      <div class="chart-wrapper tall"><canvas id="targetChartDX"></canvas></div>
    </div>
    <div id="targetChart-UX" class="product-chart-panel" style="display:none;">
      <div class="chart-wrapper tall"><canvas id="targetChartUX"></canvas></div>
    </div>
    <div id="targetChart-VP" class="product-chart-panel" style="display:none;">
      <div class="chart-wrapper tall"><canvas id="targetChartVP"></canvas></div>
    </div>
  </div>

  <!-- CHARTS ROW 1 -->
  <div class="charts-grid">
    <div class="chart-container">
      <div class="chart-wrapper"><canvas id="productComparisonChart"></canvas></div>
    </div>
    <div class="chart-container">
      <div class="chart-wrapper"><canvas id="varianceChart"></canvas></div>
    </div>
  </div>

  <!-- CHARTS ROW 2 -->
  <div class="charts-grid">
    <div class="chart-container">
      <div class="chart-wrapper"><canvas id="deliveryChart"></canvas></div>
    </div>
    <div class="chart-container">
      <div class="chart-wrapper"><canvas id="dipVarianceChart"></canvas></div>
    </div>
  </div>

  <!-- TARGET VS ACTUAL BAR CHART -->
  <div class="chart-container">
    <div class="chart-wrapper">
      <canvas id="targetVsActualChart"></canvas>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div class="insights-section">
    <div class="section-title">üö® Key Insights & Alerts</div>
    <ul class="insights-list" id="insightsList"></ul>
  </div>

  <!-- DATA TABLE -->
  <div class="table-section">
    <div class="section-title">üìã Detailed Product Data</div>
    <div class="table-scroll">
      <table id="dataTable"></table>
    </div>
  </div>

  <footer>
    <p><strong>¬© 2026 Kiryan Energy Ltd ‚Äî All Rights Reserved</strong></p>
    <p><strong>Confidential:</strong> This dashboard is for official use only.</p>
    <p>Data refreshed automatically ¬∑ Dashboard v2.2 ¬∑ Target Tracking Enabled</p>
  </footer>
</div>

<script>
  // ============================================================================
  // DATA SOURCES
  // ============================================================================
  const dataSources = {
    "October 2025": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-k0UvgWAF628NHqYnQ58rXfOpyMnrqnRa19R-icgOlkeK2yEhP3hg2_9CtwYCHZ08ciLYioLZNTc7/pub?gid=1772695434&single=true&output=csv",
    "November 2025": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7ZVd1O2MMZPQ-eNdmAdfyzuTXLa-KOMwxFibhN0c5nBm1TywXnsyElaKeifVZHH3HOnTL8xZkiHlJ/pub?gid=1772695434&single=true&output=csv",
    "December 2025": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS6iyMOviuAKEPtY-l7IOcbpkpWIm6hHVz5ongtl9A6xv2idj2VqJ5shpPcteJ-QAMsdQvMgYUpaQec/pub?gid=1772695434&single=true&output=csv",
    "January 2026": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRT8Kama3jzM7pEBPHUY-hUKgiV5Mbp0VC5CN4_-r2MckRoU2xxGcwQb31qeRKjXLg2NHH0eDQlmu3C/pub?gid=1772695434&single=true&output=csv",
  };

  // ============================================================================
  // 2026 MONTHLY TARGETS (litres)
  // ============================================================================
  const MONTHLY_TARGETS = {
    'UX': 88593,
    'DX': 91152,
    'VP': 11104
  };

  const PRODUCT_COLORS = {
    'DX': '#111827',
    'UX': '#10b981',
    'VP': '#dc2626'
  };
  const PRODUCT_NAMES = {
    'DX': 'DX Diesel',
    'UX': 'UX Unleaded Super',
    'VP': 'VP Shell V-Power'
  };

  // ============================================================================
  // HELPERS
  // ============================================================================
  let allData = [];
  let charts = {};

  function getDaysInMonth(monthStr) {
    // "January 2026" -> Date object
    const d = new Date(monthStr + ' 1');
    return new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
  }

  function getTodayDayOfMonth() {
    return new Date().getDate();
  }

  function getSelectedMonth() {
    return document.getElementById('monthFilter').value;
  }

  function initializeMonthFilter() {
    const sel = document.getElementById('monthFilter');
    sel.innerHTML = '';
    Object.keys(dataSources).reverse().forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      sel.appendChild(opt);
    });
  }

  function csvToArray(csv) {
    const lines = csv.trim().split('\n');
    function parseLine(line) {
      const result = []; let cur = ''; let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const c = line[i], n = line[i+1];
        if (c === '"') { if (inQ && n === '"') { cur += '"'; i++; } else { inQ = !inQ; } }
        else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
        else cur += c;
      }
      result.push(cur);
      return result.map(f => f.trim());
    }
    const headers = parseLine(lines[0]);
    return lines.slice(1).map(line => {
      const items = parseLine(line);
      let obj = {};
      headers.forEach((h, i) => { obj[h] = items[i] || ''; });
      return obj;
    });
  }

  function formatDate(s) {
    if (!s) return null;
    const p = s.trim().split('.');
    if (p.length === 3) {
      return `${p[0].padStart(4,'0')}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
    }
    return s;
  }

  function fmtDisp(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  // ============================================================================
  // DATA LOAD
  // ============================================================================
  async function loadData() {
    const selectedMonth = getSelectedMonth();
    const csvUrl = dataSources[selectedMonth];
    document.getElementById('metricsGrid').innerHTML = '<div class="spinner-wrap" style="grid-column:1/-1"><div class="spinner"></div></div>';
    try {
      const resp = await fetch(csvUrl);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const text = await resp.text();
      const rows = csvToArray(text);
      allData = [];
      let lastDate = null;
      const parseNum = v => { if (!v) return 0; return parseFloat(v.toString().replace(/,/g,'')) || 0; };

      rows.forEach(row => {
        const dv = row.DATE ? row.DATE.toString().trim() : '';
        if (dv && !dv.toUpperCase().includes('TOTAL')) lastDate = dv;
        if (!lastDate || (dv && dv.toUpperCase().includes('TOTAL'))) return;
        const date = formatDate(lastDate);
        if (!date || !date.match(/^\d{4}-\d{2}-\d{2}$/)) return;
        const product = (row.PRODUCT || '').toString().trim().toUpperCase();
        if (!['UX','DX','VP'].includes(product)) return;
        const meterSale = parseNum(row['METER SALE']);
        const dipSale = parseNum(row['DIP SALE']);
        if (meterSale > 0 || dipSale > 0) {
          allData.push({
            date, product,
            openDip: parseNum(row['OPEN DIP']),
            delivery: parseNum(row['DELIVERY']),
            closeDip: parseNum(row['CLOSE DIP']),
            dipSale, meterSale,
            variance: parseNum(row['VAR']),
            variancePct: parseNum(row['EXPLAIN > 5%']),
            comments: row.COMMENTS || ''
          });
        }
      });

      allData.sort((a, b) => new Date(a.date) - new Date(b.date));
      updateDashboard();
    } catch (e) {
      document.getElementById('metricsGrid').innerHTML = `
        <div style="grid-column:1/-1;text-align:center;padding:40px;color:#dc2626;">
          <h3>‚ùå Error loading data</h3><p>${e.message}</p>
          <button class="btn" onclick="loadData()" style="margin-top:15px;">üîÑ Retry</button>
        </div>`;
    }
  }

  function getFilteredData() {
    const pf = document.getElementById('productFilter').value;
    const vf = document.getElementById('varianceFilter').value;
    return allData.filter(row => {
      if (pf !== 'all' && row.product !== pf) return false;
      if (vf !== 'all') {
        const a = Math.abs(row.variancePct);
        if (vf === 'high' && a <= 5) return false;
        if (vf === 'medium' && (a < 2 || a > 5)) return false;
        if (vf === 'low' && a >= 2) return false;
      }
      return true;
    });
  }

  // ============================================================================
  // UPDATE TARGET CARDS
  // ============================================================================
  function updateTargetCards(data) {
    const selectedMonth = getSelectedMonth();
    const daysInMonth = getDaysInMonth(selectedMonth);
    
    // Determine how many days of data we have
    const dates = [...new Set(data.map(r => r.date))].sort();
    const daysElapsed = dates.length > 0 ? dates.length : 1;
    
    // Is this the current month? (rough check)
    const now = new Date();
    const monthDate = new Date(selectedMonth + ' 1');
    const isCurrentMonth = (now.getFullYear() === monthDate.getFullYear() && now.getMonth() === monthDate.getMonth());
    const effectiveDaysElapsed = isCurrentMonth ? Math.max(daysElapsed, getTodayDayOfMonth()) : daysElapsed;

    const productSales = { UX: 0, DX: 0, VP: 0 };
    data.forEach(r => { if (productSales[r.product] !== undefined) productSales[r.product] += r.meterSale; });

    const cardClasses = { DX: 'diesel', UX: 'unleaded', VP: 'vpower' };

    const html = ['DX','UX','VP'].map(product => {
      const sold = productSales[product];
      const target = MONTHLY_TARGETS[product];
      const pct = Math.min((sold / target) * 100, 100);
      const remaining = Math.max(target - sold, 0);
      const daysLeft = Math.max(daysInMonth - effectiveDaysElapsed, 0);
      const dailyRequired = daysLeft > 0 ? remaining / daysLeft : 0;
      const expectedPace = (target / daysInMonth) * effectiveDaysElapsed;
      const pacePct = Math.min((expectedPace / target) * 100, 100);

      // Status
      let statusClass, badgeClass, badgeText;
      if (pct >= pacePct - 5) {
        statusClass = 'on-track'; badgeClass = 'badge-on-track'; badgeText = '‚úÖ On Track';
      } else if (pct >= pacePct - 15) {
        statusClass = 'below'; badgeClass = 'badge-below'; badgeText = '‚ö†Ô∏è Below Pace';
      } else {
        statusClass = 'critical'; badgeClass = 'badge-critical'; badgeText = 'üö® Behind Target';
      }

      return `
        <div class="target-card ${cardClasses[product]}">
          <div class="tc-product">
            <span class="tc-dot"></span>
            ${PRODUCT_NAMES[product]}
          </div>
          <div class="tc-numbers">
            <div class="tc-num-item">
              <div class="tc-val">${sold.toLocaleString(undefined,{maximumFractionDigits:0})} L</div>
              <div class="tc-lbl">Sold This Month</div>
            </div>
            <div class="tc-num-item">
              <div class="tc-val">${target.toLocaleString()} L</div>
              <div class="tc-lbl">Monthly Target</div>
            </div>
            <div class="tc-num-item">
              <div class="tc-val">${remaining.toLocaleString(undefined,{maximumFractionDigits:0})} L</div>
              <div class="tc-lbl">Remaining</div>
            </div>
            <div class="tc-num-item">
              <div class="tc-val">${dailyRequired.toLocaleString(undefined,{maximumFractionDigits:0})} L</div>
              <div class="tc-lbl">Needed/Day</div>
            </div>
          </div>
          <div class="progress-track">
            <div class="progress-fill ${statusClass}" style="width:${pct}%;"></div>
            <div class="pace-marker" style="left:${pacePct}%;"></div>
          </div>
          <div class="tc-pct">
            <span>${pct.toFixed(1)}% achieved</span>
            <span>Expected: ${pacePct.toFixed(1)}%</span>
          </div>
          <div class="tc-status-badge ${badgeClass}">${badgeText}</div>
          <div style="font-size:0.78em;opacity:0.6;margin-top:6px;">${daysLeft} days remaining ¬∑ ${daysInMonth}-day month</div>
        </div>`;
    }).join('');

    document.getElementById('targetCards').innerHTML = html;
  }

  // ============================================================================
  // UPDATE METRICS
  // ============================================================================
  function updateMetrics(data) {
    const totalSales = data.reduce((s,r) => s+r.meterSale, 0);
    const totalDeliveries = data.reduce((s,r) => s+r.delivery, 0);
    const avgVar = data.length ? data.reduce((s,r) => s+Math.abs(r.variancePct),0)/data.length : 0;
    const highVar = data.filter(r => Math.abs(r.variancePct) > 5).length;

    const prodTotals = {};
    data.forEach(r => { prodTotals[r.product] = (prodTotals[r.product]||0)+r.meterSale; });
    const topP = Object.keys(prodTotals).reduce((a,b) => prodTotals[a]>prodTotals[b]?a:b, Object.keys(prodTotals)[0]||'N/A');

    // Latest stock
    const latestStock = {};
    data.forEach(r => {
      if (!latestStock[r.product] || r.date > latestStock[r.product].date) latestStock[r.product] = r;
    });
    let lowStock = 0;
    Object.entries(latestStock).forEach(([p,r]) => {
      if ((p==='VP' && r.closeDip<1000)||(['UX','DX'].includes(p) && r.closeDip<3000)) lowStock++;
    });

    // Total target vs actual
    const totalTarget = Object.values(MONTHLY_TARGETS).reduce((a,b)=>a+b,0);
    const overallPct = ((totalSales/totalTarget)*100).toFixed(1);

    document.getElementById('metricsGrid').innerHTML = `
      <div class="metric-card">
        <div class="m-icon">üí∞</div>
        <div class="m-value">${totalSales.toLocaleString(undefined,{maximumFractionDigits:0})} L</div>
        <div class="m-label">Total Meter Sales</div>
      </div>
      <div class="metric-card">
        <div class="m-icon">üöö</div>
        <div class="m-value">${totalDeliveries.toLocaleString()} L</div>
        <div class="m-label">Total Deliveries</div>
      </div>
      <div class="metric-card ${avgVar>5?'red-top':avgVar>2?'amber-top':'green-top'}">
        <div class="m-icon">üìä</div>
        <div class="m-value">${avgVar.toFixed(2)}%</div>
        <div class="m-label">Avg Variance</div>
      </div>
      <div class="metric-card ${highVar>0?'red-top':'green-top'}">
        <div class="m-icon">üö®</div>
        <div class="m-value">${highVar}</div>
        <div class="m-label">High Variance Alerts</div>
      </div>
      <div class="metric-card ${lowStock>0?'amber-top':'green-top'}">
        <div class="m-icon">‚ö†Ô∏è</div>
        <div class="m-value">${lowStock}</div>
        <div class="m-label">Low Stock Alerts</div>
      </div>
      <div class="metric-card ${parseFloat(overallPct)<70?'red-top':parseFloat(overallPct)<90?'amber-top':'green-top'}">
        <div class="m-icon">üéØ</div>
        <div class="m-value">${overallPct}%</div>
        <div class="m-label">Overall Target Progress</div>
      </div>
    `;

    updateStockAlerts(latestStock);
  }

  // ============================================================================
  // STOCK ALERTS
  // ============================================================================
  function updateStockAlerts(latestStock) {
    const thresholds = { UX:3000, DX:3000, VP:1000 };
    let criticals = [], warnings = [], safes = [];

    ['UX','DX','VP'].forEach(p => {
      const s = latestStock[p]; if (!s) return;
      const th = thresholds[p];
      const pctTh = (s.closeDip/th)*100;
      const item = { p, closeDip: s.closeDip, threshold: th, date: s.date, pctTh };
      if (s.closeDip < th*0.5) { criticals.push({...item, status:'critical', label:'üö® CRITICAL ‚Äî Reorder Now!'}); }
      else if (s.closeDip < th) { warnings.push({...item, status:'warning', label:'‚ö†Ô∏è Warning ‚Äî Low Stock'}); }
      else { safes.push({...item, status:'safe', label:'‚úÖ Stock Level OK'}); }
    });

    const sectionClass = criticals.length?'has-critical':warnings.length?'has-warning':'all-safe';
    const icon = criticals.length?'üö®':warnings.length?'‚ö†Ô∏è':'‚úÖ';
    const title = criticals.length?'CRITICAL STOCK ALERT':warnings.length?'Low Stock Warning':'Stock Levels Normal';

    const allItems = [...criticals,...warnings,...safes];
    const itemsHtml = allItems.map(item => {
      const color = PRODUCT_COLORS[item.p];
      return `
        <div class="stock-item ${item.status}">
          <div class="si-name" style="color:${color}">
            <span style="display:inline-block;width:10px;height:10px;background:${color};border-radius:50%;margin-right:6px;"></span>
            ${PRODUCT_NAMES[item.p]}
          </div>
          <div class="si-level ${item.status}">${item.closeDip.toLocaleString()} L</div>
          <div style="font-size:0.8em;color:#64748b">Threshold: ${item.threshold.toLocaleString()} L</div>
          <div class="si-bar"><div class="si-fill ${item.status}" style="width:${Math.min(item.pctTh,100)}%"></div></div>
          <div style="font-size:0.78em;color:#64748b;margin-bottom:6px">${item.pctTh.toFixed(1)}% of threshold</div>
          <span class="si-status ${item.status}">${item.label}</span>
          <div style="font-size:0.78em;color:#94a3b8;margin-top:6px">As of ${fmtDisp(item.date)}</div>
        </div>`;
    }).join('');

    document.getElementById('stockAlertSection').innerHTML = `
      <div class="stock-section ${sectionClass}" style="margin-bottom:24px;">
        <div class="section-title">${icon} ${title}</div>
        <div class="stock-items">${itemsHtml}</div>
      </div>`;
  }

  // ============================================================================
  // CHARTS
  // ============================================================================
  function createCharts(data) {
    Object.values(charts).forEach(c => c.destroy());
    charts = {};

    const selectedMonth = getSelectedMonth();
    const daysInMonth = getDaysInMonth(selectedMonth);

    // -- PER-PRODUCT DAILY SALES vs DAILY TARGET (shaded gap) --
    const dailySales = {};
    data.forEach(row => {
      if (!dailySales[row.date]) dailySales[row.date] = {};
      dailySales[row.date][row.product] = (dailySales[row.date][row.product]||0)+row.meterSale;
    });
    const dates = Object.keys(dailySales).sort();

    // Custom plugin: shade gap between actual and target line
    // green where actual >= target, red where actual < target
    const shadedGapPlugin = {
      id: 'shadedGap',
      afterDatasetsDraw(chart) {
        const { ctx, chartArea: { top, bottom }, scales: { x, y } } = chart;
        // dataset 0 = actual, dataset 1 = target
        const actualMeta = chart.getDatasetMeta(0);
        const targetMeta = chart.getDatasetMeta(1);
        if (!actualMeta.data.length || !targetMeta.data.length) return;

        ctx.save();
        ctx.beginPath();
        ctx.rect(chart.chartArea.left, top, chart.chartArea.right - chart.chartArea.left, bottom - top);
        ctx.clip();

        const n = actualMeta.data.length;
        for (let i = 0; i < n - 1; i++) {
          const ax0 = actualMeta.data[i].x,   ay0 = actualMeta.data[i].y;
          const ax1 = actualMeta.data[i+1].x, ay1 = actualMeta.data[i+1].y;
          const tx0 = targetMeta.data[i].x,   ty0 = targetMeta.data[i].y;
          const tx1 = targetMeta.data[i+1].x, ty1 = targetMeta.data[i+1].y;

          // Check if lines cross between i and i+1
          const da0 = ay0 - ty0, da1 = ay1 - ty1;
          const hasCross = (da0 > 0 && da1 < 0) || (da0 < 0 && da1 > 0);

          if (!hasCross) {
            // Simple quad ‚Äî one colour
            const isAbove = da0 <= 0; // note: canvas y is inverted, above target = ay < ty
            ctx.beginPath();
            ctx.moveTo(ax0, ay0);
            ctx.lineTo(ax1, ay1);
            ctx.lineTo(tx1, ty1);
            ctx.lineTo(tx0, ty0);
            ctx.closePath();
            ctx.fillStyle = isAbove ? 'rgba(16,185,129,0.22)' : 'rgba(220,38,38,0.20)';
            ctx.fill();
          } else {
            // Find crossing X
            const crossT = da0 / (da0 - da1);
            const crossX = ax0 + crossT * (ax1 - ax0);
            const crossY = ay0 + crossT * (ay1 - ay0);

            // First segment
            ctx.beginPath();
            ctx.moveTo(ax0, ay0); ctx.lineTo(crossX, crossY);
            ctx.lineTo(tx0 + crossT*(tx1-tx0), crossY); // target at crossing
            ctx.lineTo(tx0, ty0); ctx.closePath();
            ctx.fillStyle = da0 <= 0 ? 'rgba(16,185,129,0.22)' : 'rgba(220,38,38,0.20)';
            ctx.fill();

            // Second segment
            ctx.beginPath();
            ctx.moveTo(crossX, crossY); ctx.lineTo(ax1, ay1);
            ctx.lineTo(tx1, ty1);
            ctx.lineTo(tx0 + crossT*(tx1-tx0), crossY); ctx.closePath();
            ctx.fillStyle = da1 <= 0 ? 'rgba(16,185,129,0.22)' : 'rgba(220,38,38,0.20)';
            ctx.fill();
          }
        }
        ctx.restore();
      }
    };

    function buildProductTargetChart(canvasId, product) {
      const productColor = PRODUCT_COLORS[product];
      const dailyTarget = MONTHLY_TARGETS[product] / daysInMonth;
      const actualData = dates.map(d => dailySales[d]?.[product] || 0);
      const targetLine = dates.map(() => parseFloat(dailyTarget.toFixed(2)));

      if (charts[`target_${product}`]) charts[`target_${product}`].destroy();

      charts[`target_${product}`] = new Chart(document.getElementById(canvasId).getContext('2d'), {
        type: 'line',
        plugins: [shadedGapPlugin],
        data: {
          labels: dates.map(fmtDisp),
          datasets: [
            {
              label: `${PRODUCT_NAMES[product]} ‚Äî Actual Daily Sales`,
              data: actualData,
              borderColor: productColor,
              backgroundColor: 'transparent',
              borderWidth: 2.5,
              tension: 0.35,
              fill: false,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: actualData.map(v => v >= dailyTarget ? '#10b981' : '#dc2626'),
              pointBorderColor: 'white',
              pointBorderWidth: 1.5,
              order: 1
            },
            {
              label: `Daily Target (${dailyTarget.toLocaleString(undefined,{maximumFractionDigits:1})} L/day)`,
              data: targetLine,
              borderColor: '#f59e0b',
              backgroundColor: 'transparent',
              borderWidth: 2,
              borderDash: [10, 5],
              tension: 0,
              fill: false,
              pointRadius: 0,
              order: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                afterBody(items) {
                  const idx = items[0]?.dataIndex;
                  if (idx === undefined) return '';
                  const actual = actualData[idx];
                  const diff = actual - dailyTarget;
                  const sign = diff >= 0 ? '+' : '';
                  const status = diff >= 0 ? '‚úÖ Above target' : 'üî¥ Below target';
                  return [`${status}: ${sign}${diff.toLocaleString(undefined,{maximumFractionDigits:1})} L`];
                }
              }
            }
          },
          scales: {
            x: { grid: { color: 'rgba(0,0,0,0.05)' } },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.06)' },
              ticks: { callback: v => v.toLocaleString() + ' L' },
              title: { display: true, text: 'Litres Sold' }
            }
          }
        }
      });
    }

    // Build all three charts upfront (hidden ones are fine, chart renders on show)
    buildProductTargetChart('targetChartDX', 'DX');
    buildProductTargetChart('targetChartUX', 'UX');
    buildProductTargetChart('targetChartVP', 'VP');

    // -- TARGET VS ACTUAL BAR CHART --
    const productSales = { UX:0, DX:0, VP:0 };
    data.forEach(r => { productSales[r.product] = (productSales[r.product]||0)+r.meterSale; });

    const targetDataset = ['DX','UX','VP'].map(p => MONTHLY_TARGETS[p]);
    const actualDataset = ['DX','UX','VP'].map(p => productSales[p]);

    // Use product brand colors: DX = black, UX = green, VP = red
    const barColors = ['DX','UX','VP'].map(p => PRODUCT_COLORS[p]);

    charts.targetVsActual = new Chart(document.getElementById('targetVsActualChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['DX Diesel','UX Unleaded Super','VP Shell V-Power'],
        datasets: [
          { label: 'üéØ Monthly Target', data: targetDataset, backgroundColor: 'rgba(99,102,241,0.25)', borderColor: '#6366f1', borderWidth: 2, borderRadius: 6 },
          { label: '‚úÖ Actual Sales', data: actualDataset, backgroundColor: barColors.map(c=>c+'bb'), borderColor: barColors, borderWidth: 2, borderRadius: 6 }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'Actual Sales vs Monthly Target by Product', font: { size: 15, weight: 'bold' } },
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              afterDatasetsDraw: () => {},
              afterBody: (items) => {
                const p = ['DX','UX','VP'][items[0]?.dataIndex];
                const pct = (productSales[p]/MONTHLY_TARGETS[p]*100).toFixed(1);
                return `Progress: ${pct}%`;
              }
            }
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString()+'L' } }
        }
      }
    });

    // -- PRODUCT COMPARISON --
    const pKeys = ['DX','UX','VP'].filter(p=>productSales[p]);
    charts.productComparison = new Chart(document.getElementById('productComparisonChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: pKeys.map(p=>PRODUCT_NAMES[p]),
        datasets: [{ label: 'Total Sales (L)', data: pKeys.map(p=>productSales[p]), backgroundColor: pKeys.map(p=>PRODUCT_COLORS[p]), borderRadius: 8 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'Product Sales Comparison', font: { size: 14, weight: 'bold' } },
          legend: { display: false }
        },
        scales: { y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString()+'L' } } }
      }
    });

    // -- VARIANCE DISTRIBUTION --
    const varCat = { 'Low (<2%)':0, 'Medium (2‚Äì5%)':0, 'High (>5%)':0 };
    data.forEach(r => {
      const a = Math.abs(r.variancePct);
      if (a<2) varCat['Low (<2%)']++;
      else if (a<=5) varCat['Medium (2‚Äì5%)']++;
      else varCat['High (>5%)']++;
    });
    charts.variance = new Chart(document.getElementById('varianceChart').getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(varCat),
        datasets: [{ data: Object.values(varCat), backgroundColor: ['#10b981','#d97706','#dc2626'], borderWidth: 3, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Variance Distribution', font: { size: 14, weight: 'bold' } }, legend: { position: 'bottom' } }
      }
    });

    // -- DELIVERIES --
    const delivByProd = {};
    data.forEach(r => { if (r.delivery>0) delivByProd[r.product] = (delivByProd[r.product]||0)+r.delivery; });
    const dp = ['DX','UX','VP'].filter(p=>delivByProd[p]);
    charts.delivery = new Chart(document.getElementById('deliveryChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: dp.map(p=>PRODUCT_NAMES[p]),
        datasets: [{ label: 'Total Deliveries (L)', data: dp.map(p=>delivByProd[p]), backgroundColor: dp.map(p=>PRODUCT_COLORS[p]), borderRadius: 8 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Deliveries by Product', font: { size: 14, weight: 'bold' } }, legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString()+'L' } } }
      }
    });

    // -- VARIANCE TREND --
    const varTime = {};
    data.forEach(r => { if (!varTime[r.date]) varTime[r.date]=[]; varTime[r.date].push(r.variancePct); });
    const avgVarDate = {};
    Object.keys(varTime).forEach(d => { avgVarDate[d] = varTime[d].reduce((a,b)=>a+b,0)/varTime[d].length; });
    const vDates = Object.keys(avgVarDate).sort();
    charts.dipVariance = new Chart(document.getElementById('dipVarianceChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: vDates.map(fmtDisp),
        datasets: [{ label: 'Avg Variance %', data: vDates.map(d=>avgVarDate[d]), borderColor: '#dc2626', backgroundColor: '#dc262622', tension: 0.4, fill: true }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Variance Trend Over Time', font: { size: 14, weight: 'bold' } }, legend: { display: false } },
        scales: { y: { ticks: { callback: v => v.toFixed(1)+'%' } } }
      }
    });
  }

  // ============================================================================
  // INSIGHTS
  // ============================================================================
  function updateInsights(data) {
    const selectedMonth = getSelectedMonth();
    const daysInMonth = getDaysInMonth(selectedMonth);
    const dates = [...new Set(data.map(r=>r.date))].sort();
    const daysElapsed = dates.length||1;
    const daysLeft = Math.max(daysInMonth-daysElapsed,0);

    const highVar = data.filter(r=>Math.abs(r.variancePct)>5);
    const totalSales = data.reduce((s,r)=>s+r.meterSale,0);
    const totalVar = data.reduce((s,r)=>s+r.variance,0);
    const worstVar = data.reduce((m,r)=>Math.abs(r.variancePct)>Math.abs(m.variancePct)?r:m, data[0]||{});

    // Target insights per product
    const prodSales = { UX:0, DX:0, VP:0 };
    data.forEach(r=>{ if(prodSales[r.product]!==undefined) prodSales[r.product]+=r.meterSale; });

    const targetInsights = ['DX','UX','VP'].map(p => {
      const sold = prodSales[p], target = MONTHLY_TARGETS[p];
      const pct = (sold/target*100).toFixed(1);
      const remaining = Math.max(target-sold,0);
      const dailyNeeded = daysLeft>0?(remaining/daysLeft).toFixed(0):0;
      const expectedPace = (target/daysInMonth)*daysElapsed;
      const behindBy = expectedPace - sold;
      const status = behindBy > target*0.1 ? 'üö®' : behindBy > 0 ? '‚ö†Ô∏è' : '‚úÖ';
      return `${status} <strong>${PRODUCT_NAMES[p]}</strong>: ${pct}% of target achieved. Need <strong>${Number(dailyNeeded).toLocaleString()} L/day</strong> over ${daysLeft} remaining days.`;
    });

    const insights = [
      ...targetInsights,
      `üìä Total meter sales: <strong>${totalSales.toLocaleString(undefined,{maximumFractionDigits:0})} L</strong> across ${data.length} records`,
      `üö® High variance: <strong>${highVar.length}</strong> incidents (${((highVar.length/data.length)*100).toFixed(1)}% of records)`,
      `üìâ Total variance: <strong>${totalVar.toFixed(2)} L</strong> (${((totalVar/totalSales)*100).toFixed(2)}% of sales)`,
      worstVar.date ? `‚ö†Ô∏è Worst variance day: <strong>${fmtDisp(worstVar.date)}</strong> ‚Äî ${PRODUCT_NAMES[worstVar.product]} at <strong>${worstVar.variancePct?.toFixed(2)}%</strong>` : '',
      `üí° Recommendation: ${highVar.length > 5 ? 'Immediate investigation required for variance control' : 'Variance levels are within acceptable range'}`
    ].filter(Boolean);

    document.getElementById('insightsList').innerHTML = insights.map(i=>`<li>${i}</li>`).join('');
  }

  // ============================================================================
  // DATA TABLE
  // ============================================================================
  function updateDataTable(data) {
    let html = `<thead><tr>
      <th>üìÖ Date</th><th>üè∑Ô∏è Product</th><th>üìä Open Dip</th><th>üöö Delivery</th>
      <th>üìä Close Dip</th><th>üìâ Dip Sale</th><th>üí∞ Meter Sale</th><th>üìä Variance</th><th>üìà Var %</th>
    </tr></thead><tbody>`;
    data.slice().reverse().forEach(row => {
      const vc = row.variance >= 0 ? 'var-pos' : 'var-neg';
      const ac = Math.abs(row.variancePct)>5 ? 'var-alert' : '';
      const color = PRODUCT_COLORS[row.product];
      html += `<tr>
        <td>${fmtDisp(row.date)}</td>
        <td><strong style="color:${color}"><span style="display:inline-block;width:8px;height:8px;background:${color};border-radius:50%;margin-right:5px;"></span>${row.product}</strong></td>
        <td>${row.openDip.toLocaleString()}</td><td>${row.delivery.toLocaleString()}</td>
        <td>${row.closeDip.toLocaleString()}</td><td>${row.dipSale.toLocaleString()}</td>
        <td><strong>${row.meterSale.toLocaleString(undefined,{maximumFractionDigits:2})}</strong></td>
        <td class="${vc}">${row.variance>0?'+':''}${row.variance.toFixed(2)}</td>
        <td class="${vc} ${ac}">${row.variancePct>0?'+':''}${row.variancePct.toFixed(2)}%</td>
      </tr>`;
    });
    document.getElementById('dataTable').innerHTML = html + '</tbody>';
  }

  // ============================================================================
  // TAB SWITCHER for per-product charts
  // ============================================================================
  function switchTab(product) {
    ['DX','UX','VP'].forEach(p => {
      document.getElementById(`targetChart-${p}`).style.display = p === product ? 'block' : 'none';
      document.getElementById(`tab-${p}`).classList.toggle('active', p === product);
    });
    // Trigger resize so chart renders correctly after being hidden
    setTimeout(() => { if (charts[`target_${product}`]) charts[`target_${product}`].resize(); }, 50);
  }

  // ============================================================================
  // MAIN UPDATE
  // ============================================================================
  function updateDashboard() {
    const filtered = getFilteredData();
    if (filtered.length === 0) {
      document.getElementById('metricsGrid').innerHTML = `
        <div style="grid-column:1/-1;text-align:center;padding:40px;color:#64748b;">
          <h3>No data matches current filters</h3><p>Try adjusting filters</p>
        </div>`;
      return;
    }
    updateMetrics(filtered);
    updateTargetCards(filtered);
    createCharts(filtered);
    updateInsights(filtered);
    updateDataTable(filtered);
    // Reset tab to DX after rebuild
    switchTab('DX');
  }

  window.onload = () => {
    initializeMonthFilter();
    loadData();
  };
</script>
</body>
</html>
