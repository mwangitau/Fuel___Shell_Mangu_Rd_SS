<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fuel Product Analysis Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); 
      min-height: 100vh;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    /* Configuration Helper Section */
    .config-helper {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      border-left: 5px solid #4caf50;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
    }
    .config-helper h3 {
      margin-top: 0;
      color: #2e7d32;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .config-helper code {
      background: #fff;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      color: #d32f2f;
    }
    .config-helper ol {
      margin: 10px 0;
      padding-left: 25px;
    }
    .config-helper li {
      margin: 8px 0;
      line-height: 1.6;
    }
    
    h1 {
      text-align: center;
      color: #1e293b;
      margin-bottom: 10px;
      font-size: 2.8em;
      background: linear-gradient(45deg, #1e3c72, #7e22ce);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle {
      text-align: center;
      color: #64748b;
      font-size: 1.1em;
      margin-bottom: 30px;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .metric-card {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .metric-card.warning {
      background: linear-gradient(135deg, #dc2626, #991b1b);
    }
    .metric-card.success {
      background: linear-gradient(135deg, #059669, #047857);
    }
    .metric-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      transition: all 0.5s;
      opacity: 0;
    }
    .metric-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 15px 35px rgba(0,0,0,0.25);
    }
    .metric-card:hover::before {
      opacity: 1;
      animation: shimmer 0.6s ease-in-out;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%) rotate(45deg); }
      100% { transform: translateX(100%) rotate(45deg); }
    }
    .metric-value {
      font-size: 2.4em;
      font-weight: bold;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }
    .metric-label {
      font-size: 0.95em;
      opacity: 0.95;
      position: relative;
      z-index: 1;
    }
    .metric-icon {
      font-size: 1.8em;
      margin-bottom: 10px;
      opacity: 0.9;
    }
    .chart-container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      transition: transform 0.2s ease;
    }
    .chart-container:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 25px;
      margin-bottom: 25px;
    }
    .filter-section {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      padding: 20px;
      border-radius: 15px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .filter-label {
      font-size: 0.9em;
      color: #475569;
      font-weight: 600;
    }
    select, button {
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    select:hover, button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
    }
    button {
      background: linear-gradient(135deg, #7e22ce, #6b21a8);
      font-weight: 600;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .data-table th, .data-table td {
      padding: 15px 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    .data-table th {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .data-table tbody tr:hover {
      background: rgba(30, 60, 114, 0.05);
    }
    .variance-positive {
      color: #059669;
      font-weight: bold;
    }
    .variance-negative {
      color: #dc2626;
      font-weight: bold;
    }
    .variance-alert {
      background: #fee2e2;
      padding: 2px 8px;
      border-radius: 5px;
    }
    .analysis-section {
      background: linear-gradient(135deg, #f8fafc, #ffffff);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border-left: 5px solid #1e3c72;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .analysis-section h3 {
      color: #1e293b;
      margin-bottom: 15px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .insights-list {
      list-style: none;
      padding: 0;
    }
    .insights-list li {
      background: white;
      margin: 12px 0;
      padding: 18px;
      border-radius: 10px;
      border-left: 4px solid #7e22ce;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .insights-list li:hover {
      transform: translateX(8px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    .alert-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: bold;
      margin-left: 10px;
    }
    .alert-high {
      background: #fee2e2;
      color: #dc2626;
    }
    .alert-medium {
      background: #fef3c7;
      color: #d97706;
    }
    .stock-alert-section {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border-left: 5px solid #dc2626;
      box-shadow: 0 5px 15px rgba(220, 38, 38, 0.2);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 5px 15px rgba(220, 38, 38, 0.2); }
      50% { box-shadow: 0 5px 25px rgba(220, 38, 38, 0.4); }
    }
    .stock-alert-section.warning {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-left-color: #d97706;
    }
    .stock-alert-section.safe {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      border-left-color: #059669;
      animation: none;
    }
    .stock-alert-section h3 {
      color: #dc2626;
      margin-bottom: 15px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stock-alert-section.warning h3 {
      color: #d97706;
    }
    .stock-alert-section.safe h3 {
      color: #059669;
    }
    .stock-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stock-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .stock-item:hover {
      transform: translateY(-3px);
    }
    .stock-item.critical {
      border: 3px solid #dc2626;
      background: #fef2f2;
    }
    .stock-item.warning {
      border: 3px solid #d97706;
      background: #fffbeb;
    }
    .stock-item.safe {
      border: 3px solid #059669;
      background: #f0fdf4;
    }
    .stock-product-name {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #1e293b;
    }
    .stock-level {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }
    .stock-item.critical .stock-level {
      color: #dc2626;
    }
    .stock-item.warning .stock-level {
      color: #d97706;
    }
    .stock-item.safe .stock-level {
      color: #059669;
    }
    .stock-status {
      font-size: 0.9em;
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
      margin-top: 5px;
    }
    .stock-item.critical .stock-status {
      background: #dc2626;
      color: white;
    }
    .stock-item.warning .stock-status {
      background: #d97706;
      color: white;
    }
    .stock-item.safe .stock-status {
      background: #059669;
      color: white;
    }
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1e3c72;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    footer {
      margin-top: 40px;
      padding: 25px;
      background: linear-gradient(135deg, #1e293b, #334155);
      color: white;
      border-radius: 15px;
      font-size: 13px;
      line-height: 1.6;
      text-align: center;
    }
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
      .metrics-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚õΩ Fuel Product Analysis Dashboard</h1>
    <div class="subtitle">Inventory Management & Variance Tracking</div>
    
    <!-- Configuration Helper (Remove this section after you're comfortable) -->
    <div class="config-helper" id="configHelper">
      <h3>üí° Quick Setup Guide - Product Dashboard</h3>
      <p><strong>To add a new month of product data:</strong></p>
      <ol>
        <li>Open your Google Sheet and go to <strong>File ‚Üí Share ‚Üí Publish to web</strong></li>
        <li>Select the product analysis sheet/tab, choose <strong>CSV</strong> format, click <strong>Publish</strong></li>
        <li>Copy the published CSV link</li>
        <li>In the code below (line ~445), add your month like this:<br>
            <code>"December": "YOUR_CSV_LINK_HERE"</code></li>
        <li>Save and refresh! Your new month appears in the dropdown automatically üéâ</li>
      </ol>
      <p><strong>Note:</strong> Your sheet must have these columns: <code>DATE, PRODUCT, OPEN DIP, DELIVERY, CLOSE DIP, DIP SALE, METER SALE, VAR, EXPLAIN &gt; 5%</code></p>
      <button onclick="document.getElementById('configHelper').style.display='none'" 
              style="background: #4caf50; margin-top: 10px; cursor: pointer;">
        ‚úì Got it, hide this message
      </button>
    </div>
    
    <div class="metrics-grid" id="metricsGrid">
      <div class="loading-spinner"><div class="spinner"></div></div>
    </div>
    
    <div id="stockAlertSection"></div>
    
    <div class="filter-section">
      <div class="filter-group">
        <label class="filter-label">üìÖ Month</label>
        <select id="monthFilter" onchange="loadData()">
          <!-- Options will be auto-populated from dataSources -->
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">üì¶ Product Filter</label>
        <select id="productFilter">
          <option value="all">All Products</option>
          <option value="UX">UX - Unleaded Super (Green)</option>
          <option value="DX">DX - Diesel (Black)</option>
          <option value="VP">VP - V-Power (Red)</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">üìä Variance Threshold</label>
        <select id="varianceFilter">
          <option value="all">All Variances</option>
          <option value="high">High Alert (>5%)</option>
          <option value="medium">Medium (2-5%)</option>
          <option value="low">Low (<2%)</option>
        </select>
      </div>
      <button onclick="updateDashboard()">üîÑ Update Analysis</button>
    </div>
    
    <div class="chart-container" style="height: 450px;">
      <canvas id="salesTrendChart"></canvas>
    </div>
    
    <div class="charts-grid">
      <div class="chart-container">
        <canvas id="productComparisonChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="varianceChart"></canvas>
      </div>
    </div>
    
    <div class="charts-grid">
      <div class="chart-container">
        <canvas id="deliveryChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="dipVarianceChart"></canvas>
      </div>
    </div>
    
    <div class="analysis-section">
      <h3>üö® Key Insights & Alerts</h3>
      <ul class="insights-list" id="insightsList"></ul>
    </div>
    
    <div class="analysis-section">
      <h3>üìã Detailed Product Data</h3>
      <div style="overflow-x: auto; max-height: 500px;">
        <table class="data-table" id="dataTable"></table>
      </div>
    </div>
    
    <footer>
      <p><strong>¬© 2025 Kiryan Energy Ltd ‚Äî All Rights Reserved</strong></p>
      <p><strong>Confidential:</strong> This dashboard is for official use only.</p>
      <p>Data refreshed automatically ‚Ä¢ Dashboard v2.1 ‚Ä¢ Easy Config</p>
    </footer>
  </div>

  <script>
    // ============================================================================
    // üìù CONFIGURATION SECTION - ADD YOUR MONTHS HERE!
    // ============================================================================
    // To add a new month, simply add a new line like:
    // "MonthName": "YOUR_GOOGLE_SHEETS_CSV_LINK",
    // 
    // The dropdown will automatically update with all months below!
    // ============================================================================
    
    const dataSources = {
      "October": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-k0UvgWAF628NHqYnQ58rXfOpyMnrqnRa19R-icgOlkeK2yEhP3hg2_9CtwYCHZ08ciLYioLZNTc7/pub?gid=1772695434&single=true&output=csv",
      // Add more months here as needed:
      "November": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7ZVd1O2MMZPQ-eNdmAdfyzuTXLa-KOMwxFibhN0c5nBm1TywXnsyElaKeifVZHH3HOnTL8xZkiHlJ/pub?gid=1772695434&single=true&output=csv",
      // "December": "YOUR_CSV_LINK_HERE",
    };
    
    // ============================================================================
    // üé® PRODUCT COLOR CONFIGURATION
    // ============================================================================
    // Customize your product colors here!
    // DX Diesel = Black, UX Unleaded Super = Green, VP V-Power = Red
    // ============================================================================
    
    const PRODUCT_COLORS = {
      'DX': '#000000',      // Black - Diesel
      'UX': '#10b981',      // Green - Unleaded Super
      'VP': '#dc2626'       // Red - V-Power
    };
    
    const PRODUCT_NAMES = {
      'DX': 'DX Diesel',
      'UX': 'UX Unleaded Super',
      'VP': 'VP Shell V-Power'
    };
    
    // ============================================================================
    // üîß AUTOMATIC SETUP - NO NEED TO EDIT BELOW THIS LINE!
    // ============================================================================
    
    let allData = [];
    let charts = {};

    // Auto-populate month dropdown on page load
    function initializeMonthFilter() {
      const monthFilter = document.getElementById('monthFilter');
      monthFilter.innerHTML = '';
      
      // Get months in reverse chronological order (newest first)
      const months = Object.keys(dataSources).reverse();
      
      months.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthFilter.appendChild(option);
      });
      
      console.log(`‚úÖ Initialized with ${months.length} months: ${months.join(', ')}`);
    }

    function csvToArray(csv, delimiter = ',') {
      const lines = csv.trim().split('\n');
      
      // Parse CSV line properly, handling quoted fields
      function parseLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          const nextChar = line[i + 1];
          
          if (char === '"') {
            if (inQuotes && nextChar === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === delimiter && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current);
        return result.map(field => field.trim());
      }
      
      const headers = parseLine(lines[0]);
      return lines.slice(1).map(line => {
        const items = parseLine(line);
        let obj = {};
        headers.forEach((h, i) => {
          obj[h] = items[i] || "";
        });
        return obj;
      });
    }

    function formatDate(dateStr) {
      // Handle format like "2025.10.01" or "2025.10.1"
      if (!dateStr) return null;
      const parts = dateStr.trim().split(".");
      if (parts.length === 3) {
        const year = parts[0].padStart(4, '0');
        const month = parts[1].padStart(2, '0');
        const day = parts[2].padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
      return dateStr;
    }

    function formatDisplayDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric'
      });
    }

    async function loadData() {
      try {
        const selectedMonth = document.getElementById('monthFilter').value;
        const csvUrl = dataSources[selectedMonth];
        
        document.getElementById('metricsGrid').innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
        
        console.log(`üì• Loading ${selectedMonth} product data...`);
        const response = await fetch(csvUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const text = await response.text();
        if (!text || text.trim() === '') {
          throw new Error('Empty response from Google Sheets');
        }
        
        console.log('Data received, parsing...');
        const rows = csvToArray(text);
        console.log('Sample row:', rows[0]);
        console.log(`   Parsed ${rows.length} rows`);
        
        allData = [];
        let lastDate = null; // Keep track of the last valid date
        let validRows = 0;
        
        rows.forEach((row, index) => {
          // Handle empty DATE cells - use the last date we saw
          const dateValue = row.DATE ? row.DATE.toString().trim() : '';
          
          if (dateValue && dateValue !== '' && !dateValue.toUpperCase().includes('TOTAL')) {
            lastDate = dateValue;
          }
          
          // Skip if we don't have a date yet or if this is a total row
          if (!lastDate || (dateValue && dateValue.toUpperCase().includes('TOTAL'))) return;
          
          const date = formatDate(lastDate);
          if (!date || !date.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return;
          }
          
          const product = (row.PRODUCT || '').toString().trim().toUpperCase();
          if (!product || !['UX', 'DX', 'VP'].includes(product)) {
            return;
          }
          
          // Parse numeric values, handling potential comma separators
          const parseNum = (val) => {
            if (!val) return 0;
            const str = val.toString().replace(/,/g, '');
            return parseFloat(str) || 0;
          };
          
          const openDip = parseNum(row['OPEN DIP']);
          const delivery = parseNum(row['DELIVERY']);
          const closeDip = parseNum(row['CLOSE DIP']);
          const dipSale = parseNum(row['DIP SALE']);
          const meterSale = parseNum(row['METER SALE']);
          const variance = parseNum(row['VAR']);
          const variancePct = parseNum(row['EXPLAIN > 5%']);
          
          if (meterSale > 0 || dipSale > 0) {
            allData.push({
              date,
              product,
              openDip,
              delivery,
              closeDip,
              dipSale,
              meterSale,
              variance,
              variancePct,
              comments: row.COMMENTS || ''
            });
            validRows++;
          }
        });
        
        console.log(`   ‚úÖ ${validRows} valid product records added from ${selectedMonth}`);
        
        if (allData.length === 0) {
          throw new Error('No valid data found. Please check the Google Sheet column names.');
        }
        
        allData.sort((a, b) => new Date(a.date) - new Date(b.date));
        updateDashboard();
        
      } catch (error) {
        console.error('‚ùå Error loading data:', error);
        document.getElementById('metricsGrid').innerHTML = `
          <div style="grid-column: 1 / -1; color: #dc2626; text-align: center; padding: 40px;">
            <h3 style="color: #dc2626;">‚ùå Data Loading Error</h3>
            <p><strong>Error:</strong> ${error.message}</p>
            <p><strong>Troubleshooting Tips:</strong></p>
            <ul style="text-align: left; margin: 15px auto; max-width: 600px;">
              <li>Make sure your Google Sheet is <strong>Published to web</strong></li>
              <li>Verify the CSV link is correct and accessible</li>
              <li>Check column names: DATE, PRODUCT, OPEN DIP, DELIVERY, CLOSE DIP, DIP SALE, METER SALE, VAR, EXPLAIN > 5%</li>
            </ul>
            <button onclick="loadData()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 15px;">
              üîÑ Retry
            </button>
          </div>
        `;
      }
    }

    function getFilteredData() {
      const productFilter = document.getElementById('productFilter').value;
      const varianceFilter = document.getElementById('varianceFilter').value;
      
      return allData.filter(row => {
        // Product filter
        if (productFilter !== 'all' && row.product !== productFilter) {
          return false;
        }
        
        // Variance filter
        if (varianceFilter !== 'all') {
          const absVariance = Math.abs(row.variancePct);
          if (varianceFilter === 'high' && absVariance <= 5) return false;
          if (varianceFilter === 'medium' && (absVariance < 2 || absVariance > 5)) return false;
          if (varianceFilter === 'low' && absVariance >= 2) return false;
        }
        
        return true;
      });
    }

    function updateMetrics(data) {
      const totalSales = data.reduce((sum, row) => sum + row.meterSale, 0);
      const totalDeliveries = data.reduce((sum, row) => sum + row.delivery, 0);
      const avgVariance = data.length > 0 ? data.reduce((sum, row) => sum + Math.abs(row.variancePct), 0) / data.length : 0;
      
      const highVariances = data.filter(row => Math.abs(row.variancePct) > 5).length;
      const varianceStatus = highVariances > data.length * 0.2 ? 'warning' : 'success';
      
      // Product breakdown
      const productTotals = {};
      data.forEach(row => {
        if (!productTotals[row.product]) {
          productTotals[row.product] = 0;
        }
        productTotals[row.product] += row.meterSale;
      });
      
      const topProduct = Object.keys(productTotals).reduce((a, b) => 
        productTotals[a] > productTotals[b] ? a : b, Object.keys(productTotals)[0] || 'N/A');
      
      // Check stock alerts
      const latestStockByProduct = {};
      data.forEach(row => {
        if (!latestStockByProduct[row.product] || row.date > latestStockByProduct[row.product].date) {
          latestStockByProduct[row.product] = row;
        }
      });
      
      let lowStockCount = 0;
      Object.keys(latestStockByProduct).forEach(product => {
        const closeDip = latestStockByProduct[product].closeDip;
        if (product === 'VP' && closeDip < 1000) lowStockCount++;
        if ((product === 'UX' || product === 'DX') && closeDip < 3000) lowStockCount++;
      });
      
      document.getElementById('metricsGrid').innerHTML = `
        <div class="metric-card">
          <div class="metric-icon">üí∞</div>
          <div class="metric-value">${totalSales.toLocaleString(undefined, {maximumFractionDigits: 0})} L</div>
          <div class="metric-label">Total Meter Sales</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">üöö</div>
          <div class="metric-value">${totalDeliveries.toLocaleString()} L</div>
          <div class="metric-label">Total Deliveries</div>
        </div>
        <div class="metric-card ${varianceStatus}">
          <div class="metric-icon">üìä</div>
          <div class="metric-value">${avgVariance.toFixed(2)}%</div>
          <div class="metric-label">Avg Variance</div>
        </div>
        <div class="metric-card ${highVariances > 0 ? 'warning' : 'success'}">
          <div class="metric-icon">üö®</div>
          <div class="metric-value">${highVariances}</div>
          <div class="metric-label">High Variance Alerts</div>
        </div>
        <div class="metric-card ${lowStockCount > 0 ? 'warning' : 'success'}">
          <div class="metric-icon">‚ö†Ô∏è</div>
          <div class="metric-value">${lowStockCount}</div>
          <div class="metric-label">Low Stock Alerts</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">üèÜ</div>
          <div class="metric-value">${PRODUCT_NAMES[topProduct] || topProduct}</div>
          <div class="metric-label">Top Selling Product</div>
        </div>
      `;
      
      updateStockAlerts(latestStockByProduct);
    }

    function updateStockAlerts(latestStockByProduct) {
      const stockThresholds = {
        'UX': 3000,
        'DX': 3000,
        'VP': 1000
      };
      
      let criticalAlerts = [];
      let warningAlerts = [];
      let safeProducts = [];
      
      ['UX', 'DX', 'VP'].forEach(product => {
        const stock = latestStockByProduct[product];
        if (!stock) return;
        
        const threshold = stockThresholds[product];
        const closeDip = stock.closeDip;
        const percentOfThreshold = (closeDip / threshold) * 100;
        
        let status = 'safe';
        let statusText = 'Stock Level OK';
        
        if (closeDip < threshold * 0.5) {
          status = 'critical';
          statusText = 'üö® CRITICAL - Reorder Now!';
          criticalAlerts.push({ product, closeDip, threshold, date: stock.date, percentOfThreshold });
        } else if (closeDip < threshold) {
          status = 'warning';
          statusText = '‚ö†Ô∏è Warning - Low Stock';
          warningAlerts.push({ product, closeDip, threshold, date: stock.date, percentOfThreshold });
        } else {
          safeProducts.push({ product, closeDip, threshold, date: stock.date, percentOfThreshold });
        }
        
        stock.stockStatus = status;
        stock.statusText = statusText;
      });
      
      const hasAlerts = criticalAlerts.length > 0 || warningAlerts.length > 0;
      const sectionClass = criticalAlerts.length > 0 ? '' : warningAlerts.length > 0 ? 'warning' : 'safe';
      const titleIcon = criticalAlerts.length > 0 ? 'üö®' : warningAlerts.length > 0 ? '‚ö†Ô∏è' : '‚úÖ';
      const titleText = criticalAlerts.length > 0 ? 'CRITICAL STOCK ALERT' : 
                        warningAlerts.length > 0 ? 'Low Stock Warning' : 
                        'Stock Levels Normal';
      
      let html = `<div class="stock-alert-section ${sectionClass}">
        <h3>${titleIcon} ${titleText}</h3>`;
      
      if (hasAlerts) {
        html += '<div class="stock-items">';
        
        [...criticalAlerts, ...warningAlerts, ...safeProducts].forEach(alert => {
          const stock = latestStockByProduct[alert.product];
          const productName = PRODUCT_NAMES[alert.product];
          const productColor = PRODUCT_COLORS[alert.product];
          
          html += `
            <div class="stock-item ${stock.stockStatus}">
              <div class="stock-product-name" style="color: ${productColor};">
                <span style="display: inline-block; width: 15px; height: 15px; background: ${productColor}; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>
                ${productName}
              </div>
              <div class="stock-level">${alert.closeDip.toLocaleString()} L</div>
              <div>Threshold: ${alert.threshold.toLocaleString()} L</div>
              <div style="margin: 5px 0;">
                <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                  <div style="background: ${stock.stockStatus === 'critical' ? '#dc2626' : stock.stockStatus === 'warning' ? '#d97706' : '#059669'}; 
                              height: 100%; width: ${Math.min(alert.percentOfThreshold, 100)}%; transition: width 0.3s;"></div>
                </div>
                <div style="font-size: 0.85em; color: #64748b; margin-top: 3px;">${alert.percentOfThreshold.toFixed(1)}% of threshold</div>
              </div>
              <div class="stock-status">${stock.statusText}</div>
              <div style="font-size: 0.85em; color: #64748b; margin-top: 8px;">As of ${formatDisplayDate(alert.date)}</div>
            </div>
          `;
        });
        
        html += '</div>';
      } else {
        html += '<p style="font-size: 1.1em; margin: 10px 0;">All product stock levels are above safety thresholds. ‚úÖ</p>';
        html += '<div class="stock-items">';
        
        safeProducts.forEach(alert => {
          const stock = latestStockByProduct[alert.product];
          const productName = PRODUCT_NAMES[alert.product];
          const productColor = PRODUCT_COLORS[alert.product];
          
          html += `
            <div class="stock-item ${stock.stockStatus}">
              <div class="stock-product-name" style="color: ${productColor};">
                <span style="display: inline-block; width: 15px; height: 15px; background: ${productColor}; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>
                ${productName}
              </div>
              <div class="stock-level">${alert.closeDip.toLocaleString()} L</div>
              <div>Threshold: ${alert.threshold.toLocaleString()} L</div>
              <div style="margin: 5px 0;">
                <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                  <div style="background: #059669; height: 100%; width: ${Math.min(alert.percentOfThreshold, 100)}%; transition: width 0.3s;"></div>
                </div>
                <div style="font-size: 0.85em; color: #64748b; margin-top: 3px;">${alert.percentOfThreshold.toFixed(1)}% of threshold</div>
              </div>
              <div class="stock-status">${stock.statusText}</div>
              <div style="font-size: 0.85em; color: #64748b; margin-top: 8px;">As of ${formatDisplayDate(alert.date)}</div>
            </div>
          `;
        });
        
        html += '</div>';
      }
      
      html += '</div>';
      
      document.getElementById('stockAlertSection').innerHTML = html;
    }

    function createCharts(data) {
      // Destroy existing charts
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};
      
      // Daily sales trend
      const dailySales = {};
      data.forEach(row => {
        if (!dailySales[row.date]) {
          dailySales[row.date] = {};
        }
        dailySales[row.date][row.product] = (dailySales[row.date][row.product] || 0) + row.meterSale;
      });
      
      const dates = Object.keys(dailySales).sort();
      const products = ['DX', 'UX', 'VP'];
      const datasets = products.map((product) => {
        return {
          label: PRODUCT_NAMES[product],
          data: dates.map(date => dailySales[date][product] || 0),
          borderColor: PRODUCT_COLORS[product],
          backgroundColor: PRODUCT_COLORS[product] + '33',
          tension: 0.4,
          fill: false
        };
      });
      
      charts.salesTrend = new Chart(document.getElementById('salesTrendChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: dates.map(d => formatDisplayDate(d)),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Daily Sales Trend by Product', font: { size: 16, weight: 'bold' } },
            legend: { position: 'top' }
          },
          scales: {
            y: { 
              beginAtZero: true,
              ticks: { callback: v => v.toLocaleString() + ' L' }
            }
          }
        }
      });
      
      // Product comparison
      const productSales = {};
      data.forEach(row => {
        productSales[row.product] = (productSales[row.product] || 0) + row.meterSale;
      });
      
      const sortedProducts = ['DX', 'UX', 'VP'].filter(p => productSales[p]);
      
      charts.productComparison = new Chart(document.getElementById('productComparisonChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: sortedProducts.map(p => PRODUCT_NAMES[p]),
          datasets: [{
            label: 'Total Sales (L)',
            data: sortedProducts.map(p => productSales[p]),
            backgroundColor: sortedProducts.map(p => PRODUCT_COLORS[p]),
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Product Sales Comparison', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { 
              beginAtZero: true,
              ticks: { callback: v => v.toLocaleString() + ' L' }
            }
          }
        }
      });
      
      // Variance distribution
      const varianceCategories = { 'Low (<2%)': 0, 'Medium (2-5%)': 0, 'High (>5%)': 0 };
      data.forEach(row => {
        const absVar = Math.abs(row.variancePct);
        if (absVar < 2) varianceCategories['Low (<2%)']++;
        else if (absVar <= 5) varianceCategories['Medium (2-5%)']++;
        else varianceCategories['High (>5%)']++;
      });
      
      charts.variance = new Chart(document.getElementById('varianceChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(varianceCategories),
          datasets: [{
            data: Object.values(varianceCategories),
            backgroundColor: ['#10b981', '#d97706', '#dc2626'],
            borderWidth: 3,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Variance Distribution', font: { size: 16, weight: 'bold' } },
            legend: { position: 'bottom' }
          }
        }
      });
      
      // Delivery analysis
      const deliveryByProduct = {};
      data.forEach(row => {
        if (row.delivery > 0) {
          deliveryByProduct[row.product] = (deliveryByProduct[row.product] || 0) + row.delivery;
        }
      });
      
      const deliveryProducts = ['DX', 'UX', 'VP'].filter(p => deliveryByProduct[p]);
      
      charts.delivery = new Chart(document.getElementById('deliveryChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: deliveryProducts.map(p => PRODUCT_NAMES[p]),
          datasets: [{
            label: 'Total Deliveries (L)',
            data: deliveryProducts.map(p => deliveryByProduct[p]),
            backgroundColor: deliveryProducts.map(p => PRODUCT_COLORS[p]),
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Deliveries by Product', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { 
              beginAtZero: true,
              ticks: { callback: v => v.toLocaleString() + ' L' }
            }
          }
        }
      });
      
      // Dip vs Meter variance over time
      const varianceOverTime = {};
      data.forEach(row => {
        if (!varianceOverTime[row.date]) {
          varianceOverTime[row.date] = [];
        }
        varianceOverTime[row.date].push(row.variancePct);
      });
      
      const avgVarianceByDate = {};
      Object.keys(varianceOverTime).forEach(date => {
        const variances = varianceOverTime[date];
        avgVarianceByDate[date] = variances.reduce((a, b) => a + b, 0) / variances.length;
      });
      
      charts.dipVariance = new Chart(document.getElementById('dipVarianceChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: Object.keys(avgVarianceByDate).sort().map(d => formatDisplayDate(d)),
          datasets: [{
            label: 'Avg Variance %',
            data: Object.values(avgVarianceByDate),
            borderColor: '#dc2626',
            backgroundColor: '#dc262633',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Variance Trend Over Time', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { 
              ticks: { callback: v => v.toFixed(1) + '%' }
            }
          }
        }
      });
    }

    function updateInsights(data) {
      const highVariances = data.filter(row => Math.abs(row.variancePct) > 5);
      const totalSales = data.reduce((sum, row) => sum + row.meterSale, 0);
      const totalVariance = data.reduce((sum, row) => sum + row.variance, 0);
      
      // Find worst variance day
      const worstVariance = data.reduce((max, row) => 
        Math.abs(row.variancePct) > Math.abs(max.variancePct) ? row : max, data[0] || {});
      
      // Product with most variance issues
      const productVariances = {};
      data.forEach(row => {
        if (!productVariances[row.product]) {
          productVariances[row.product] = { count: 0, total: 0 };
        }
        if (Math.abs(row.variancePct) > 5) {
          productVariances[row.product].count++;
        }
        productVariances[row.product].total++;
      });
      
      let worstProduct = null;
      let worstRate = 0;
      Object.keys(productVariances).forEach(product => {
        const rate = productVariances[product].count / productVariances[product].total;
        if (rate > worstRate) {
          worstRate = rate;
          worstProduct = product;
        }
      });
      
      const insights = [
        `üìä Total meter sales: <strong>${totalSales.toLocaleString(undefined, {maximumFractionDigits: 0})} L</strong> across ${data.length} records`,
        `üö® High variance alerts: <strong>${highVariances.length}</strong> incidents (${((highVariances.length / data.length) * 100).toFixed(1)}% of records) <span class="alert-badge ${highVariances.length > data.length * 0.2 ? 'alert-high' : 'alert-medium'}">${highVariances.length > data.length * 0.2 ? 'CRITICAL' : 'MONITOR'}</span>`,
        `üìâ Total variance: <strong>${totalVariance.toFixed(2)} L</strong> (${((totalVariance / totalSales) * 100).toFixed(2)}% of total sales)`,
        `‚ö†Ô∏è Worst variance day: <strong>${formatDisplayDate(worstVariance.date)}</strong> - ${PRODUCT_NAMES[worstVariance.product]} with <strong>${worstVariance.variancePct.toFixed(2)}%</strong> variance`,
        worstProduct ? `üîç Product needing attention: <strong>${PRODUCT_NAMES[worstProduct]}</strong> has high variance rate of <strong>${(worstRate * 100).toFixed(1)}%</strong>` : '',
        `üí° Recommendation: ${highVariances.length > 5 ? 'Immediate investigation required for variance control measures' : 'Variance levels are within acceptable range'}`
      ].filter(insight => insight !== '');
      
      document.getElementById('insightsList').innerHTML = insights.map(i => `<li>${i}</li>`).join('');
    }

    function updateDataTable(data) {
      let html = `
        <thead>
          <tr>
            <th>üìÖ Date</th>
            <th>üè∑Ô∏è Product</th>
            <th>üìä Open Dip</th>
            <th>üöö Delivery</th>
            <th>üìä Close Dip</th>
            <th>üìâ Dip Sale</th>
            <th>üí∞ Meter Sale</th>
            <th>üìä Variance</th>
            <th>üìà Variance %</th>
          </tr>
        </thead>
        <tbody>`;
      
      data.slice().reverse().forEach(row => {
        const varianceClass = row.variance >= 0 ? 'variance-positive' : 'variance-negative';
        const alertClass = Math.abs(row.variancePct) > 5 ? 'variance-alert' : '';
        const productColor = PRODUCT_COLORS[row.product];
        
        html += `
          <tr>
            <td>${formatDisplayDate(row.date)}</td>
            <td>
              <strong style="color: ${productColor};">
                <span style="display: inline-block; width: 10px; height: 10px; background: ${productColor}; border-radius: 50%; margin-right: 5px;"></span>
                ${row.product}
              </strong>
            </td>
            <td>${row.openDip.toLocaleString()}</td>
            <td>${row.delivery.toLocaleString()}</td>
            <td>${row.closeDip.toLocaleString()}</td>
            <td>${row.dipSale.toLocaleString()}</td>
            <td><strong>${row.meterSale.toLocaleString(undefined, {maximumFractionDigits: 2})}</strong></td>
            <td class="${varianceClass}">${row.variance > 0 ? '+' : ''}${row.variance.toFixed(2)}</td>
            <td class="${varianceClass} ${alertClass}">${row.variancePct > 0 ? '+' : ''}${row.variancePct.toFixed(2)}%</td>
          </tr>`;
      });
      
      html += `</tbody>`;
      document.getElementById('dataTable').innerHTML = html;
    }

    function updateDashboard() {
      const filtered = getFilteredData();
      
      if (filtered.length === 0) {
        document.getElementById('metricsGrid').innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b;">
            <h3>No data matches the current filters</h3>
            <p>Try adjusting your filter settings</p>
          </div>
        `;
        return;
      }
      
      updateMetrics(filtered);
      createCharts(filtered);
      updateInsights(filtered);
      updateDataTable(filtered);
    }

    // Initialize and load data on page load
    window.onload = () => {
      initializeMonthFilter();
      loadData();
    };
  </script>
</body>
</html>
